<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 播放量儀表板</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5; /* 背景顏色 */
        }
        .container {
            max-width: 1200px; /* 最大寬度 */
            margin: 0 auto; /* 置中 */
            background-color: white; /* 內容區塊背景 */
            padding: 20px;
            border-radius: 8px; /* 圓角 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* 陰影 */
        }
        h1 { 
            color: #333; 
            text-align: center;
        }
        p { 
            text-align: center; 
            color: #666; 
        }
        button { 
            display: block; /* 讓按鈕獨立一行 */
            margin: 10px auto; /* 置中並加邊距 */
            padding: 10px 20px; 
            background-color: #0070f3; /* 按鈕顏色 */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0051cc; /* 滑鼠懸停顏色 */
        }
        #chartContainer { 
            width: 100%; 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 10px; /* 內距 */
            border: 1px solid #ddd; /* 邊框 */
            border-radius: 4px; /* 圓角 */
        }
        #status { 
            color: #666; 
            font-style: italic; 
            text-align: center; /* 置中 */
        }
        #dataTableContainer {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse; /* 合併邊框 */
            margin-top: 10px; /* 表格上方間距 */
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center; /* 文字置中 */
        }
        th {
            background-color: #f2f2f2; /* 標題列背景 */
        }
        tr:nth-child(even) {
            background-color: #f9f9f9; /* 斑馬紋 */
        }
        .change-positive { color: green; } /* 正增長顏色 */
        .change-negative { color: red; }   /* 負增長顏色 */
        .change-zero { color: gray; }      /* 零增長顏色 */
    </style>
</head>
<body>
    <div class="container">
        <h1>YouTube 播放量追蹤儀表板</h1>
        <p>目前追蹤影片: <a href="https://www.youtube.com/watch?v=m2ANkjMRuXc" target="_blank">https://www.youtube.com/watch?v=m2ANkjMRuXc</a></p>
        <button id="refreshButton">刷新圖表與表格</button>
        <div id="status">載入中...</div>
        
        <div id="chartContainer">
            <canvas id="viewChart"></canvas>
        </div>

        <div id="dataTableContainer">
            <h2>詳細數據</h2>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>日期時間</th>
                        <th>播放量</th>
                        <th>播放量變化</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 表格內容將由 JavaScript 動態生成 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let chart;
        const statusDiv = document.getElementById('status');
        const dataTableBody = document.querySelector('#dataTable tbody');

        async function loadChartData() {
            statusDiv.textContent = '載入數據中...';
            dataTableBody.innerHTML = ''; // 清空舊的表格數據

            try {
                const response = await fetch('/api/chart-data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('從後端獲取的圖表數據:', data);

                if (data.length === 0) {
                    statusDiv.textContent = '沒有數據。請確保定時任務已開始記錄。';
                    return;
                }

                // --- 處理數據以用於圖表和表格 ---
                // 確保數據按時間戳記排序 (最新的在最後)
                data.sort((a, b) => a.timestamp - b.timestamp);

                const labels = data.map(item => {
                    // 將時間戳記格式化為更簡短的時間 (例如 MM/DD HH:MM)
                    const date = new Date(item.timestamp);
                    return date.toLocaleString('zh-TW', { 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: false 
                    });
                });
                const viewCounts = data.map(item => item.viewCount);

                // 處理表格數據
                const tableRows = data.map((item, index) => {
                    let change = 0;
                    if (index > 0) {
                        change = item.viewCount - data[index - 1].viewCount; // 修正此行
                    }
                    const dateObj = new Date(item.timestamp);
                    const formattedDateTime = dateObj.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });

                    return {
                        dateTime: formattedDateTime,
                        viewCount: item.viewCount,
                        change: change
                    };
                });

                // 更新圖表
                updateChart(labels, viewCounts);
                
                // 更新表格
                updateTable(tableRows);

                statusDiv.textContent = `數據更新時間: ${new Date().toLocaleString()}`;
            } catch (error) {
                console.error('獲取圖表數據失敗:', error);
                statusDiv.textContent = `獲取數據失敗: ${error.message}`;
                // 即使出錯，也要確保表格是空的
                dataTableBody.innerHTML = '<tr><td colspan="3">加載數據失敗</td></tr>';
            }
        }

        function updateChart(labels, viewCounts) {
            const ctx = document.getElementById('viewChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, // X 軸標籤 (時間)
                    datasets: [{
                        label: '播放量',
                        data: viewCounts, // Y 軸數據 (播放數)
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '播放量'
                            }
                        }
                    }
                }
            });
        }

        function updateTable(tableRows) {
            // 反轉順序，讓最新的在最上面
            const reversedRows = tableRows.reverse();
            
            reversedRows.forEach(row => {
                const tr = document.createElement('tr');
                
                const tdDateTime = document.createElement('td');
                tdDateTime.textContent = row.dateTime;
                
                const tdViewCount = document.createElement('td');
                tdViewCount.textContent = row.viewCount;
                
                const tdChange = document.createElement('td');
                tdChange.textContent = row.change > 0 ? '+' + row.change : row.change; // 顯示正負號
                
                // 根據變化量添加 CSS 類別以改變顏色
                if (row.change > 0) {
                    tdChange.classList.add('change-positive');
                } else if (row.change < 0) {
                    tdChange.classList.add('change-negative');
                } else {
                    tdChange.classList.add('change-zero');
                }
                
                tr.appendChild(tdDateTime);
                tr.appendChild(tdViewCount);
                tr.appendChild(tdChange);
                
                dataTableBody.appendChild(tr);
            });
        }

        document.getElementById('refreshButton').addEventListener('click', loadChartData);

        // 頁面載入時載入數據
        loadChartData();

        // 每小時自動刷新一次圖表與表格 (可選)
        // setInterval(loadChartData, 3600000);

    </script>
</body>
</html>