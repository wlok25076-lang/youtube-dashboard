async function loadChartData() {
    statusDiv.textContent = '載入數據中...';
    dataTableBody.innerHTML = ''; // 清空舊的表格數據

    try {
        const response = await fetch('/api/chart-data');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log('從後端獲取的圖表數據:', data);

        if (data.length === 0) {
            statusDiv.textContent = '沒有數據。請確保定時任務已開始記錄。';
            return;
        }

        // --- 處理數據以用於圖表和表格 ---
        // 確保數據按時間戳記排序 (最新的在最後)
        data.sort((a, b) => a.timestamp - b.timestamp);

        const labels = data.map(item => {
            // 將時間戳記格式化為更簡短的時間 (例如 MM/DD HH:MM)
            const date = new Date(item.timestamp);
            return date.toLocaleString('zh-TW', { 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false 
            });
        });
        const viewCounts = data.map(item => item.viewCount);

        // 處理表格數據
        const tableRows = data.map((item, index) => {
            let change = 0;
            if (index > 0) {
                change = item.viewCount - data[index - 1].viewCount; // 修正此行
            }
            const dateObj = new Date(item.timestamp);
            const formattedDateTime = dateObj.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            return {
                dateTime: formattedDateTime,
                viewCount: item.viewCount,
                change: change
            };
        });

        // 更新圖表
        updateChart(labels, viewCounts);
        
        // 更新表格
        updateTable(tableRows);

        statusDiv.textContent = `數據更新時間: ${new Date().toLocaleString()}`;
    } catch (error) {
        console.error('獲取圖表數據失敗:', error);
        statusDiv.textContent = `獲取數據失敗: ${error.message}`;
        // 即使出錯，也要確保表格是空的
        dataTableBody.innerHTML = '<tr><td colspan="3">加載數據失敗</td></tr>';
    }
}